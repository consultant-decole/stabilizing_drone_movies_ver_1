# stabilizing_drone_movies



## * 開発動機



子どもと一緒に遊べるトイドローンや100g未満の軽量ドローンで撮った映像が、ガタガタで観にくくなってしまって活用できていないことに気づき、何とかしたいなと思っていました。そんな中でStabilizationという方法があることを下記のサイトから知りました。



[vidstab](https://adamspannbauer.github.io/python_video_stab/html/index.html)

[vidstab on GitHub](https://github.com/AdamSpannbauer/python_video_stab)



一度作成して機能確認をして、その威力に驚きました。

ソフトウェアジンバルとも言われる機能ですね。



安価なローリングシャッターの画像の揺らぎも追加して、Antigravityエージェントで処理をするコードを作成しましたのでここでシェアします。

---

## * 実行サンプル

* 入力動画を左に、処理後の出力動画を右に対比して再生しています。

[比較動画の再生](https://github.com/user-attachments/assets/9735ee90-0748-4327-97fd-1367d398c19a)



# ビデオスタビライザー（Antigravity）処理フロー



このスクリプトは、FFmpeg（deshake / vidstab フィルタ）を利用して、ドローン映像などのローリングシャッター歪みの補正と手ブレ補正を自動化します。



---



## 0. 環境準備

* **作業フォルダの設定:** .envファイルを.env.sampleを元に作成ください（4. 実行環境を参照）

* **必要なライブラリのインストール:** requirements.txtを使ってインストールしてください（pip install -r requirements.txt）。





---



## 1. 処理の全体像



本プログラムは、1つの入力ファイルに対して大きく分けて3つの工程（2パス処理）を実行します。



---



## 2. 各ステップの詳細



### ステップ1：ローリングシャッター補正 (Pass 1)

CMOSセンサー特有の、高速移動時に発生する垂直方向の歪みを補正します。

* **使用フィルタ:** `deshake`

* **設定の特徴:** `edge=0` (zero-fill)

&nbsp;   * 補正によって生じる画面端の空白を、周辺画素の引き伸ばし（ミラーリング）ではなく、**黒塗り**で埋めます。

* **出力:** 中間ファイル `global_*.mp4` を生成。



### ステップ2：手ブレ解析 (Pass 2a - Detection)

映像の揺れを数学的に解析し、動きのデータを抽出します。

* **使用フィルタ:** `vidstabdetect`

* **設定の特徴:** * `pad_filter`: 画面サイズをあらかじめ**1.5倍に拡張**して解析します。

&nbsp;   * これにより、大きな揺れが発生してもフレームアウトせずに動きを追跡できます。

* **出力:** 解析データファイル `*_transform.trf` を生成。



### ステップ3：手ブレ補正の適用 (Pass 2b - Transform)

解析データを元に、実際に映像を安定化させます。

* **使用フィルタ:** `vidstabtransform`

* **設定の特徴:** `optzoom=0` (ズーム無効)

&nbsp;   * 通常の手ブレ補正で行われる「黒縁を隠すためのズーム」を行いません。

&nbsp;   * **「カメラが実際にどう動いたか」を可視化**するために、あえて黒縁を残した状態で出力します。



---



## 3. 技術スタック

* **Python 3.x**

* **FFmpeg** (via `imageio-ffmpeg`)

* **VidStab**: 高性能なビデオスタビライゼーションライブラリ



---



## 4. 実行環境

* **ディレクトリ設定**: .env.sampleを元にして、下記の変数をご自身の入力動画格納先と、出力動画の保存先として入力して、.envとファイル名を変更して、プログラムが参照できるように読み込ませてください。

* **入力ディレクトリ**: INPUT_DIR = "ここに入力動画保存先パス"

* **出力ディレクトリ**: OUTPUT_DIR = "ここに出力動画の保存先"

